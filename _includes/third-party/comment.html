{% if page.comment != false %}
<h2>Comments</h2>
<hr />
  {% if site.comments_provider != 'disqus' and site.lazy_load_disqus and site.disqus and site.disqus.username %}
    <a href="#" class="show_disqus_comment" onclick="return false;">Show Disqus Comments</a>
    <div id="disqus_thread"></div>
    <script>
    var disqus_config = function () {
        this.page.url = '{{ site.url }}{{ page.url }}';
        this.page.identifier = '{{ page.url }}';
        this.page.title = '{{ page.title }}';
    };
    var disqus_loaded = false;
    $(function() {
        $('.show_disqus_comment').on('click', function() { /* DON'T EDIT BELOW THIS LINE */
            $(this).html('加载中...');
            var that = this;
            if (!disqus_loaded) {
                var d = document, s = d.createElement('script');

                s.type = 'text/javascript';
                s.async = true;
                var shortname = '{{ site.disqus.username }}';

                s.src = '/mzlogin/mzlogin.github.io/blob/master/_includes/comments.html' + shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);

                disqus_loaded = true;
            }
            $(that).remove();
        })
    })
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  {% endif %}

  {% case site.comments_provider %}
    {% when 'disqus' %}
      {% if site.disqus and site.disqus.username %}
        {% assign load_disqus = true %}
        <!-- Disqus Protection, see https://kgithub.com/mzlogin/mzlogin.github.io/issues/2 -->
        {% if site.disqus.username == 'mzlogin' %}
          {% assign load_disqus = false %}
          {% if site.url contains 'mazhuang.org' %}
            {% assign load_disqus = true %}
          {% endif %}
        {% endif %}
        {% if load_disqus %}
          <div id="disqus_thread"></div>
          <script>
            var disqus_config = function () {
              this.page.url = '{{ site.url }}{{ page.url }}';
              this.page.identifier = '{{ page.url }}';
              this.page.title = '{{ page.title }}';
            };
            (function() { /* DON'T EDIT BELOW THIS LINE */
              var d = document, s = d.createElement('script');

              s.type = 'text/javascript';
              s.async = true;
              var shortname = '{{ site.disqus.username }}';

              s.src = '/mzlogin/mzlogin.github.io/blob/master/_includes/comments.html' + shortname + '.disqus.com/embed.js';

              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
            })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        {% endif %}
      {% endif %}
    {% when 'disqusjs' %}
      <link rel="stylesheet" href="{% if site.cdn.option.disqusjs_css %}{{ site.cdn.option.disqusjs_css }}{% else %}https://unpkg.com/disqusjs/dist/browser/styles/disqusjs.css{% endif %}" />
      <script src="{% if site.cdn.option.disqusjs %}{{ site.cdn.option.disqusjs }}{% else %}https://unpkg.com/disqusjs/dist/browser/disqusjs.es2015.umd.min.js{% endif %}"></script>
      <div id="disqusjs"></div>
      <script>
        let disqusjs = null;
        // 初始化 DisqusJS 实例
        disqusjs = new DisqusJS({
            shortname:'{{ site.disqusjs.shortname }}',
            siteName:'{{ site.disqusjs.siteName }}',
            title:'{{ site.disqusjs.title }}',
            api:'{{ site.disqusjs.api }}',
            apikey:'{{ site.disqusjs.apikey }}',
            nesting:'{{ site.disqusjs.nesting }}',
            nocomment:'{{ site.disqusjs.nocomment }}',
            admin:'{{ site.disqusjs_badge.admin }}',
            adminLabel:'{{ site.disqusjs_badge.adminLabel }}',
          });
        // 将 DisqusJS 渲染到页面上
        disqusjs.render(document.getElementById('disqusjs'));
    
        document.addEventListener('pjax:send', () => {
          // 销毁 DisqusJS 实例
          disqusjs.destroy();
        });
    
        document.addEventListener('pjax:complete', () => {
          // 使用新的参数（如新的 identifier 和 url）创建全新的 DisqusJS 实例
          disqusjs = new DisqusJS({
            shortname:'{{ site.disqusjs.shortname }}',
            siteName:'{{ site.disqusjs.siteName }}',
            identifier:'{{ page.url }}',
            url:'{{ site.url }}{{ page.url }}',
            title:'{{ site.disqusjs.title }}',
            api:'{{ site.disqusjs.api }}',
            apikey:'{{ site.disqusjs.apikey }}',
            nesting:'{{ site.disqusjs.nesting }}',
            nocomment:'{{ site.disqusjs.nocomment }}',
            admin:'{{ site.disqusjs_badge.admin }}',
            adminLabel:'{{ site.disqusjs_badge.adminLabel }}',
          });
          // 渲染新的 DisqusJS
          disqusjs.render(document.getElementById('disqusjs'));
        });
      </script> 
    {% when 'gitalk' %}
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="{% if site.cdn.option.gitalk_css %}{{ site.cdn.option.gitalk_css }}{% else %}https://unpkg.com/gitalk/dist/gitalk.css{% endif %}">
        <script src="{% if site.cdn.option.gitalk %}{{ site.cdn.option.gitalk }}{% else %}https://unpkg.com/gitalk/dist/gitalk.min.js{% endif %}"></script>
        <script>
        var gitalk = new Gitalk({
            id: '{{ page.url | truncate: 50, '' }}',
            clientID: '{{ site.gitalk.clientID }}',
            clientSecret: '{{ site.gitalk.clientSecret }}',
            repo: '{{ site.gitalk.repo }}',
            owner: '{{ site.gitalk.owner }}',
            admin: ['{{ site.gitalk.owner }}'],
            labels: ['gitment'],
            perPage: 50,
        });
        gitalk.render('gitalk-container');
        </script>
  {% when 'utterances' %}
        <script src="{% if site.cdn.option.utterances %}{{ site.cdn.option.utterances }}{% else %}https://utteranc.es/client.js{% endif %}"
                repo="{{ site.utterances.repo }}"
                issue-term="title"
                label="gitment"
                theme="github-light"
                crossorigin="anonymous"
                async>
        </script>
  {% when 'beaudar' %}
        <script src="{% if site.cdn.option.beaudar %}{{ site.cdn.option.beaudar }}{% else %}https://beaudar.lipk.org/client.js{% endif %}"
                repo="{{ site.beaudar.repo }}"
                issue-term="title"
                issue-label="{{ page.url | truncate: 50, '' }}"
                label="gitment"
                theme="github-light"
                comment-order="desc"
                input-position="top"
                crossorigin="anonymous"
                async>
        </script>
  {% when 'giscus' %}
        <script src="{% if site.cdn.option.giscus %}{{ site.cdn.option.giscus }}{% else %}https://giscus.app/client.js{% endif %}"
                data-repo="{{ site.giscus.repo }}"
                data-repo-id="{{ site.giscus.repo-id }}"
                data-category="{{ site.giscus.category }}"
                data-category-id="{{ site.giscus.category-id }}"
                data-mapping="title"
                data-strict="1"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="top"
                data-theme="light"
                data-lang="zh-CN"
                data-loading="lazy"
                crossorigin="anonymous"
                async>
        </script>
  {% when 'twikoo' %}
    <div id="tcomment"></div>
    <script src="{% if site.cdn.option.twikoo %}{{ site.cdn.option.twikoo }}{% else %}https://npm.elemecdn.com/twikoo/dist/twikoo.all.min.js{% endif %}"></script>
    <script>
        twikoo.init({
        envId: '{{ site.twikoo.envId }}',
        el: '#tcomment',
        region: '{{ site.twikoo.region }}',
        path: '{{ page.url }}',
        lang: '{{ site.twikoo.lang }}',
        })
    </script>
  {% when 'detalk' %}
    <div id="detalk"></div>
    <script src="{% if site.cdn.option.detalk %}{{ site.cdn.option.detalk }}{% else %}https://npm.elemecdn.com/@detalk/static/dist/detalk.js{% endif %}"></script>
    <script>
    detalk.init({
        el: "#detalk", 
        url: "{{ site.detalk.url }}",
        path: '{{ page.url }}',
    });
    </script>
  {% endcase %}
{% endif %}